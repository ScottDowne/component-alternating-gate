<polymer-element name="ceci-alternating-gate" attributes="" extends="ceci-element">
  <template>
    <link rel="stylesheet" href="component.css"></link>
    <div id="channels"></div>
    <shadow></shadow>
    <script type="text/json" id="ceci-definition">
      {
        "tags": ["alternating-gate", "low-level"],
        "thumbnail": "./thumbnail.png",
        "name": "Alternating Gate",
        "description": "Alternates output between set broadcasts from a single input",
        "broadcasts": {
          "A": {
            "label": "Output A",
            "description": "The first broadcast in the rotation.",
            "default": "green"
          },
          "B": {
            "label": "Output B",
            "description": "The second broadcast in the rotation.",
            "default": "yellow"
          },
          "C": {
            "label": "Output C",
            "description": "The third broadcast in the rotation."
          },
          "D": {
            "label": "Output D",
            "description": "The fourth broadcast in the rotation."
          },
          "E": {
            "label": "Output E",
            "description": "The fifth broadcast in the rotation."
          }
        },
        "listeners": {
          "input": {
            "description": "The input that alternates out the broadcasts.",
            "label": "Input",
            "default": true
          }
        },
        "attributes": {
        }
      }
    </script>
  </template>
  <script>
    Polymer('ceci-alternating-gate', {
      nextBroadcast : "",
      ready: function() {
        this.super();
        this.lastBroadcast = null;
        var self = this;
      },
      enteredView : function(){
        var that = this;
        this.addEventListener("channelUpdated",function(){
          this.updateChannels();
          this.updateUI();
        });
        this.updateChannels();
        this.nextBroadcast = this.activeBroadcasts[0];
        this.lastBroadcast = this.activeBroadcasts[0];
        this.updateUI();
      },
      updateUI : function(){
        Array.prototype.forEach.call(this.$.channels.querySelectorAll(".output-channel"), function(c) {
          c.classList.remove("next-up");
        });
        this.$.channels.querySelector("." + this.nextBroadcast).classList.add("next-up");
      },
      updateChannels: function(){
        var that = this;
        this.activeBroadcasts = [];
        that.$.channels.innerHTML = "";
        Array.prototype.forEach.call(this.querySelectorAll("ceci-broadcast"), function(broadcast) {
          that.activeBroadcasts.push(broadcast.getAttribute("from"));
          var channel = document.createElement("div");
          channel.classList.add("output-channel");
          channel.classList.add(broadcast.getAttribute("from"));
          channel.innerHTML = broadcast.getAttribute("from");
          that.$.channels.appendChild(channel);
        });
      },
      input: function(value) {
        this.broadcast(this.nextBroadcast, value);
        this.nextBroadcast = this.activeBroadcasts.indexOf(this.lastBroadcast) + 1;
        this.nextBroadcast %= this.activeBroadcasts.length;
        this.nextBroadcast = this.activeBroadcasts[this.nextBroadcast];
        this.lastBroadcast = this.nextBroadcast;
        this.updateUI();
      }
    });
  </script>
</polymer-element>
